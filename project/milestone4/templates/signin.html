<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crowd Count - Sign In</title>
<style>
body,html{
    height:100%;
    margin:0;
    display:flex;
    justify-content:center;
    align-items:center;
    background-color:#f4f4f9;
    font-family:Arial,sans-serif;
}
.main-wrapper{
    position:relative;
    display:flex;
    justify-content:center;
    align-items:center;
    width:100%;
    height:100%;
}
form{
    padding:30px;
    background-color:#fff;
    display:flex;
    flex-direction:column;
    gap:15px;
    border-radius:10px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
    width:320px;
    box-sizing:border-box;
}
.form-label{
    font-size:15px;
    color:#333;
    margin-bottom:5px;
}
.form-control{
    font-size:16px;
    padding:8px;
    border:1px solid #ddd;
    border-radius:6px;
    outline:none;
    width:100%;
    box-sizing:border-box;
}
.form-control:focus{
    border-color:#888;
    box-shadow:0 0 4px rgba(0,0,0,0.1);
}
#submit{
    background-color:#4a90e2;
    font-size:16px;
    color:#fff;
    border:none;
    padding:10px;
    border-radius:6px;
    cursor:pointer;
    transition:background .3s ease;
    display:block;
    margin:0 auto;
}
#submit:hover{
    background-color:#357ab8;
}
a{
    color:#4a90e2;
    text-decoration:none;
    font-weight:bold;
}
a:hover{
    text-decoration:underline;
}
.extra-text{
    font-size:14px;
    color:#555;
    text-align:center;
}
#register_h,#login_h{
    font-size:18px;
}
.error-message{
    color:red;
    font-size:13px;
    text-align:center;
    margin-top:-5px;
    margin-bottom:10px;
}
.guest-button-top{
    position:fixed;
    top:20px;
    right:20px;
    background-color:#6c757d;
    color:#fff;
    border:none;
    padding:10px 15px;
    border-radius:6px;
    cursor:pointer;
    font-size:16px;
    display:flex;
    align-items:center;
    gap:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.2);
    transition:background .3s ease;
    z-index:1000;
}
.guest-button-top:hover{
    background-color:#5a6268;
}
.guest-button-top svg{
    fill:currentColor;
    width:20px;
    height:20px;
}
</style>
</head>
<body>
<button type="button" class="guest-button-top" onclick="loginAsGuest()">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-person" viewBox="0 0 16 16">
        <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6m2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0m4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4m-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10s-3.516.68-4.168 1.332c-.678.678-.83 1.418-.832 1.664z"/>
    </svg>
    Guest Login
</button>
<form method="POST" action="/signin">
    <div class="extra-text" id="register_h">Register</div>
    <div class="extra-text" id="login_h">Login</div>
    <div class="mb-3">
        <label for="mail" class="form-label">Email</label>
        <input id="mail" type="email" class="form-control" name="email" placeholder="Enter your email" required>
    </div>
    <div class="mb-3">
        <label for="password" class="form-label">Password</label>
        <input id="password" type="password" class="form-control" name="password" placeholder="Enter your password" required>
    </div>
    <div id="user_name">
        <label for="user_name_input" class="form-label">User name</label>
        <input type="text" class="form-control" name="username" id="user_name_input" placeholder="Enter User name">
    </div>
    <div id="user_role">
        <label for="role_select" class="form-label">Role</label>
        <select class="form-control" name="role" id="role_select">
            <option value="user">Standard User</option>
            <option value="admin">Administrator</option>
        </select>
    </div>
    <div class="error-message" id="errorMessage">{{Error}}</div>
    <div><button type="submit" id="submit">Submit</button></div>
    <div class="extra-text" id="register">Don't have an account? <a href="#" onclick="detailsChange()">Register</a></div>
    <div class="extra-text" id="login">Have an account? <a href="#" onclick="detailsChange()">Login</a></div>
</form>
<script>
const login=document.getElementById("login");
const register=document.getElementById("register");
const login_h=document.getElementById("login_h");
const register_h=document.getElementById("register_h");
const user_name_div=document.getElementById("user_name");
const user_role_div=document.getElementById("user_role");
const role_select=document.getElementById("role_select");
const form=document.querySelector('form');
const error_message=document.getElementById("errorMessage");
const mailInput=document.getElementById('mail');
const passwordInput=document.getElementById('password');
const submitButton=document.getElementById('submit');

function setupForLogin(){
    register_h.style.display="none";
    user_name_div.style.display="none";
    user_role_div.style.display="none";
    register.style.display="block";
    login.style.display="none";
    login_h.style.display="block";
    form.action="/login";
    mailInput.required=true;
    passwordInput.required=true;
    mailInput.value='';
    passwordInput.value='';
    submitButton.style.display='block';
    const guestInput=document.querySelector('input[name="is_guest"]');
    if(guestInput){form.removeChild(guestInput);}
}

function setupForRegister(){
    register_h.style.display="block";
    user_name_div.style.display="block";
    user_role_div.style.display="block";
    register.style.display="none";
    login.style.display="block";
    login_h.style.display="none";
    form.action="/register";
    mailInput.required=true;
    passwordInput.required=true;
    role_select.required=true;
    submitButton.style.display='block';
    mailInput.value='';
    passwordInput.value='';
}

function detailsChange(){
    error_message.style.display="none";
    (register_h.style.display==="none")?setupForRegister():setupForLogin();
}

setupForLogin();

function loginAsGuest(){
    const formData=new FormData();
    formData.append("is_guest","true");
    formData.append("email","guest@session.com");
    formData.append("password","dummy_pass");
    fetch('/login',{method:'POST',body:formData})
    .then(response=>{
        if(response.redirected){window.location.href=response.url;}
        else{window.location.href='/index';}
    })
    .catch(error=>{
        console.error('Guest Login Error:',error);
        alert('Failed to log in as guest. Check console for details.');
    });
}

const initialMode="{{ mode }}";
if(initialMode==='register'){setupForRegister();}else{setupForLogin();}
</script>
</body>
</html>
